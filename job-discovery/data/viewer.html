<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pharma Jobs</title>
<style>
/* ── Reset & Variables ────────────────────────────────── */
:root {
  --bg: #0d1117;
  --surface: #161b22;
  --surface-hover: #1c2333;
  --surface-active: #1a2536;
  --border: #262d38;
  --border-focus: #3b82f6;
  --text: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent: #3b82f6;
  --accent-hover: #2563eb;
  --green: #22c55e;
  --green-bg: rgba(34,197,94,0.08);
  --green-border: rgba(34,197,94,0.2);
  --amber: #eab308;
  --amber-bg: rgba(234,179,8,0.08);
  --amber-border: rgba(234,179,8,0.2);
  --red: #ef4444;
  --purple: #a78bfa;
  --cyan: #22d3ee;
  --radius: 10px;
  --radius-sm: 6px;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg); color: var(--text); line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden; /* prevent horizontal scroll on mobile */
  -webkit-text-size-adjust: 100%; /* prevent iOS text inflation */
}
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }
::selection { background: var(--accent); color: #fff; }

/* ── Header ───────────────────────────────────────────── */
.header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(13,17,23,0.85); backdrop-filter: blur(16px) saturate(180%);
  -webkit-backdrop-filter: blur(16px) saturate(180%);
  border-bottom: 1px solid var(--border);
}
.header-inner {
  max-width: 900px; margin: 0 auto;
  padding: 14px 24px;
  display: flex; align-items: center; gap: 16px;
}
.logo {
  font-size: 15px; font-weight: 700; white-space: nowrap;
  letter-spacing: -0.3px; display: flex; align-items: center; gap: 6px;
}
.logo-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
.header-count {
  font-size: 12px; color: var(--text-muted); white-space: nowrap;
  margin-left: auto;
}
.header-count b { color: var(--text-secondary); font-weight: 600; }

/* ── Search ───────────────────────────────────────────── */
.search-wrap {
  max-width: 900px; margin: 0 auto;
  padding: 16px 24px 0;
}
.search-box {
  position: relative; width: 100%;
}
.search-box input {
  width: 100%; padding: 10px 14px 10px 40px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text);
  font-size: 14px; outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.search-box input:focus {
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px rgba(59,130,246,0.12);
}
.search-box input::placeholder { color: var(--text-muted); }
.search-box .search-icon {
  position: absolute; left: 13px; top: 50%; transform: translateY(-50%);
  color: var(--text-muted); width: 16px; height: 16px;
}
.search-box .search-clear {
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
  background: var(--border); border: none; color: var(--text-muted);
  width: 20px; height: 20px; border-radius: 4px;
  font-size: 11px; cursor: pointer; display: none;
  align-items: center; justify-content: center; line-height: 1;
}
.search-box .search-clear.show { display: flex; }
.search-box .search-clear:hover { background: var(--text-muted); color: var(--bg); }

/* ── Filters ──────────────────────────────────────────── */
.filters-wrap {
  max-width: 900px; margin: 0 auto;
  padding: 12px 24px 0;
  display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
}
.chip {
  padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;
  cursor: pointer; border: 1px solid var(--border);
  background: transparent; color: var(--text-secondary);
  transition: all 0.12s; user-select: none;
}
.chip:hover { border-color: var(--text-muted); color: var(--text); }
.chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.chip.active:hover { background: var(--accent-hover); }
.chip-separator {
  width: 1px; height: 20px; background: var(--border);
  margin: 0 4px; flex-shrink: 0;
}
.chip-count {
  font-size: 10px; font-weight: 600; margin-left: 3px;
  opacity: 0.7;
}

/* ── Job List ─────────────────────────────────────────── */
.main {
  max-width: 900px; margin: 0 auto;
  padding: 16px 24px 80px;
}
.job-list { display: flex; flex-direction: column; gap: 2px; touch-action: pan-y; }

/* ── Job Card ─────────────────────────────────────────── */
.job-card {
  border-radius: var(--radius); padding: 14px 18px;
  cursor: pointer; transition: background 0.1s;
  position: relative;
  border: 1px solid transparent;
}
.job-card:hover { background: var(--surface-hover); }
.job-card.active {
  background: var(--surface-active); border-color: var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
}
.job-card.focused {
  box-shadow: inset 3px 0 0 var(--accent);
}
.job-card.bay-area { border-left: 3px solid var(--amber); }
.job-card.bay-area.focused { box-shadow: inset 3px 0 0 var(--accent), -3px 0 0 var(--amber); }

/* ── Card Content ─────────────────────────────────────── */
.card-top { display: flex; align-items: flex-start; gap: 12px; }
.card-body { flex: 1; min-width: 0; }

.card-title {
  font-size: 15px; font-weight: 600; line-height: 1.35;
  color: var(--text); letter-spacing: -0.2px;
  display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap;
}
.card-title a { color: inherit; }
.card-title a:hover { color: var(--accent); text-decoration: none; }

.tag {
  font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px;
  text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0;
  position: relative; top: -1px;
}
.tag-new { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.tag-bay { background: var(--amber-bg); color: var(--amber); border: 1px solid var(--amber-border); }

.card-meta {
  display: flex; gap: 12px; margin-top: 3px;
  font-size: 12.5px; color: var(--text-muted); flex-wrap: wrap;
}
.card-meta-item { display: flex; align-items: center; gap: 3px; }

.source-dot {
  width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
}
.source-biospace { background: var(--cyan); }
.source-greenhouse { background: var(--green); }
.source-workday { background: var(--purple); }
.source-attrax { background: var(--amber); }
.source-talentbrew { background: var(--red); }

.card-desc {
  margin-top: 6px; font-size: 12.5px; line-height: 1.5;
  color: var(--text-muted);
  display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical; overflow: hidden;
}

.card-actions { flex-shrink: 0; display: flex; align-items: flex-start; gap: 6px; }
.btn-open {
  padding: 7px 14px; font-size: 12px; font-weight: 500;
  background: var(--accent); color: #fff; border: none;
  border-radius: var(--radius-sm); cursor: pointer;
  transition: background 0.12s; white-space: nowrap;
  text-decoration: none; display: inline-flex; align-items: center; gap: 5px;
}
.btn-open:hover { background: var(--accent-hover); text-decoration: none; }
.btn-open svg { width: 13px; height: 13px; }

/* ── Expanded Detail ──────────────────────────────────── */
.card-detail {
  background: var(--surface);
  border: 1px solid var(--border); border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
  padding: 16px 18px;
  animation: expandIn 0.15s ease;
}
@keyframes expandIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

.detail-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 8px; margin-bottom: 12px;
}
.detail-cell {
  padding: 8px 10px; background: var(--bg);
  border-radius: var(--radius-sm);
}
.detail-label {
  font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px;
  color: var(--text-muted); font-weight: 600; margin-bottom: 1px;
}
.detail-val { font-size: 13px; color: var(--text-secondary); word-break: break-word; }

.detail-url {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 10px; background: var(--bg);
  border-radius: var(--radius-sm); margin-bottom: 12px;
}
.detail-url a {
  font-size: 12px; flex: 1; overflow: hidden; text-overflow: ellipsis;
  white-space: nowrap; color: var(--accent);
}
.btn-copy {
  padding: 3px 8px; font-size: 10px; font-weight: 500;
  border: 1px solid var(--border); border-radius: 4px;
  background: transparent; color: var(--text-muted);
  cursor: pointer; transition: all 0.12s; flex-shrink: 0;
}
.btn-copy:hover { border-color: var(--accent); color: var(--accent); }
.btn-copy.copied { border-color: var(--green); color: var(--green); }

.detail-desc {
  padding: 12px; background: var(--bg); border-radius: var(--radius-sm);
  font-size: 13px; line-height: 1.7; color: var(--text-secondary);
  max-height: 240px; overflow-y: auto; white-space: pre-wrap;
  word-break: break-word;
}

/* ── Empty State ──────────────────────────────────────── */
.empty { text-align: center; padding: 80px 24px; }
.empty-icon { font-size: 32px; margin-bottom: 12px; color: var(--text-muted); }
.empty h3 { font-size: 16px; color: var(--text-secondary); font-weight: 500; }
.empty p { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

/* ── Keyboard Bar ─────────────────────────────────────── */
.kbd-bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(13,17,23,0.9); backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-top: 1px solid var(--border);
  padding: 6px 24px; display: flex; align-items: center;
  justify-content: center; gap: 16px; z-index: 50;
  font-size: 11px; color: var(--text-muted);
}
.kbd-bar kbd {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 3px; padding: 1px 5px; font-family: inherit;
  font-size: 10px; font-weight: 500; color: var(--text-secondary);
}

/* ── Highlight ────────────────────────────────────────── */
mark {
  background: rgba(59,130,246,0.25); color: inherit;
  border-radius: 2px; padding: 0 1px;
}

/* ── Scrollbar ────────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ── Responsive: Tablet ───────────────────────────────── */
@media (max-width: 768px) {
  .header-inner { padding: 10px 16px; gap: 12px; }
  .search-wrap { padding: 12px 16px 0; }
  .main { padding: 12px 16px 80px; }

  /* Horizontal scroll for filter chips instead of wrapping */
  .filters-wrap {
    padding: 10px 16px 0;
    flex-wrap: nowrap; overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Firefox */
    gap: 6px;
  }
  .filters-wrap::-webkit-scrollbar { display: none; }
  .chip { flex-shrink: 0; }
  .chip-separator { display: none; }

  .detail-grid { grid-template-columns: repeat(2, 1fr); }
}

/* ── Responsive: Phone ────────────────────────────────── */
@media (max-width: 480px) {
  .header-inner { padding: 8px 12px; }
  .logo { font-size: 14px; }
  .header-count { font-size: 11px; }

  .search-wrap { padding: 10px 12px 0; }
  .search-box input { padding: 12px 14px 12px 38px; font-size: 16px; /* prevents iOS zoom */ }

  .filters-wrap { padding: 8px 12px 0; }
  .chip { padding: 8px 14px; font-size: 13px; /* larger tap targets */ }

  .main { padding: 10px 12px 88px; }
  .job-card { padding: 12px 14px; }

  /* Stack card: title + meta, then actions below */
  .card-top { flex-direction: column; gap: 10px; }
  .card-body { width: 100%; }
  .card-title { font-size: 14px; }
  .card-meta { font-size: 12px; gap: 8px; }
  .card-desc { font-size: 12px; -webkit-line-clamp: 3; }

  .card-actions { width: 100%; }
  .btn-open {
    width: 100%; justify-content: center;
    padding: 10px 16px; font-size: 13px;
  }

  /* Detail panel */
  .card-detail { padding: 12px 14px; }
  .detail-grid { grid-template-columns: 1fr 1fr; gap: 6px; }
  .detail-cell { padding: 6px 8px; }
  .detail-label { font-size: 8px; }
  .detail-val { font-size: 12px; }
  .detail-url { flex-direction: column; gap: 6px; }
  .detail-url a { white-space: normal; word-break: break-all; font-size: 11px; }
  .detail-desc { font-size: 12px; max-height: 200px; }

  /* Hide keyboard hint bar on touch devices */
  .kbd-bar { display: none; }
}

/* ── Touch: larger tap targets ────────────────────────── */
@media (hover: none) and (pointer: coarse) {
  .chip { padding: 8px 14px; min-height: 36px; }
  .btn-open { min-height: 44px; }
  .btn-copy { padding: 6px 12px; font-size: 12px; min-height: 36px; }
  .search-box input { min-height: 44px; }
  .kbd-bar { display: none; }
}

/* ── Safe area for notched phones ─────────────────────── */
@supports (padding: max(0px)) {
  .header { padding-top: max(0px, env(safe-area-inset-top)); }
  .main { padding-bottom: max(80px, calc(80px + env(safe-area-inset-bottom))); }
}
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo">
      <span class="logo-dot"></span>
      Pharma Jobs
    </div>
    <div class="header-count" id="headerCount"></div>
  </div>
</header>

<div class="search-wrap">
  <div class="search-box">
    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
    </svg>
    <input type="text" id="searchInput" placeholder="Search jobs..." autofocus>
    <button class="search-clear" id="searchClear">&times;</button>
  </div>
</div>

<div class="filters-wrap" id="filters"></div>

<main class="main">
  <div class="job-list" id="jobList"></div>
</main>

<div class="kbd-bar">
  <span><kbd>j</kbd><kbd>k</kbd> navigate</span>
  <span><kbd>Enter</kbd> expand</span>
  <span><kbd>o</kbd> open</span>
  <span><kbd>/</kbd> search</span>
  <span><kbd>Esc</kbd> clear</span>
</div>

<script src="data.js"></script>
<script>
// ── Data & State ─────────────────────────────────────
let jobs = [];
let state = {
  search: '',
  location: 'all',   // all | bay | other
  company: 'all',
  sort: 'date_found-desc',
  activeIdx: -1,      // keyboard focus index
  expandedId: null,   // expanded job id
};

// ── Init ─────────────────────────────────────────────
function init() {
  if (typeof window.JOBS_DATA === 'undefined' || !Array.isArray(window.JOBS_DATA)) {
    document.getElementById('jobList').innerHTML = `
      <div class="empty"><div class="empty-icon">&#9888;</div>
      <h3>No data found</h3><p>data.js is missing or empty. Run the pipeline to generate matched jobs.</p></div>`;
    return;
  }
  jobs = window.JOBS_DATA;
  buildFilters();
  attachEvents();
  render();
}

// ── Build Filter Chips ───────────────────────────────
function buildFilters() {
  const companies = [...new Set(jobs.map(j => j.company).filter(Boolean))].sort();
  const bayCount = jobs.filter(j => j.is_bay_area).length;

  let html = '';

  // Location filter
  html += `<button class="chip active" data-group="location" data-val="all">All locations</button>`;
  if (bayCount > 0) {
    html += `<button class="chip" data-group="location" data-val="bay">Bay Area<span class="chip-count">${bayCount}</span></button>`;
    html += `<button class="chip" data-group="location" data-val="other">Other</button>`;
  }

  // Company filter (only if more than 1 company)
  if (companies.length > 1) {
    html += `<div class="chip-separator"></div>`;
    html += `<button class="chip active" data-group="company" data-val="all">All companies</button>`;
    companies.forEach(c => {
      const cnt = jobs.filter(j => j.company === c).length;
      html += `<button class="chip" data-group="company" data-val="${esc(c)}">${esc(c)}<span class="chip-count">${cnt}</span></button>`;
    });
  }

  // Sort
  html += `<div class="chip-separator"></div>`;
  html += `<select id="sortSelect" style="padding:5px 8px;background:transparent;border:1px solid var(--border);border-radius:20px;color:var(--text-secondary);font-size:12px;cursor:pointer;flex-shrink:0;min-height:36px;">
    <option value="date_found-desc">Newest first</option>
    <option value="date_found-asc">Oldest first</option>
    <option value="company-asc">Company A-Z</option>
    <option value="title-asc">Title A-Z</option>
  </select>`;

  document.getElementById('filters').innerHTML = html;
}

// ── Attach Events ────────────────────────────────────
function attachEvents() {
  // Search
  const searchInput = document.getElementById('searchInput');
  const searchClear = document.getElementById('searchClear');
  searchInput.addEventListener('input', () => {
    state.search = searchInput.value;
    searchClear.classList.toggle('show', searchInput.value.length > 0);
    state.activeIdx = -1;
    render();
  });
  searchClear.addEventListener('click', () => {
    searchInput.value = ''; searchClear.classList.remove('show');
    state.search = ''; state.activeIdx = -1;
    render(); searchInput.focus();
  });

  // Filter chips
  document.getElementById('filters').addEventListener('click', e => {
    const chip = e.target.closest('.chip');
    if (!chip || !chip.dataset.group) return;
    const group = chip.dataset.group;
    state[group] = chip.dataset.val;
    // Update active states within this group
    document.querySelectorAll(`.chip[data-group="${group}"]`).forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    state.activeIdx = -1;
    state.expandedId = null;
    render();
  });

  // Sort
  document.addEventListener('change', e => {
    if (e.target.id === 'sortSelect') {
      state.sort = e.target.value;
      render();
    }
  });

  // Card click
  document.getElementById('jobList').addEventListener('click', e => {
    // Copy button
    const copyBtn = e.target.closest('.btn-copy');
    if (copyBtn) {
      navigator.clipboard.writeText(copyBtn.dataset.url).then(() => {
        copyBtn.textContent = 'Copied'; copyBtn.classList.add('copied');
        setTimeout(() => { copyBtn.textContent = 'Copy'; copyBtn.classList.remove('copied'); }, 1500);
      });
      return;
    }
    // Don't toggle if clicking a link or button
    if (e.target.closest('a') || e.target.closest('.btn-open')) return;
    const card = e.target.closest('.job-card');
    if (!card) return;
    const id = card.dataset.id;
    state.expandedId = state.expandedId === id ? null : id;
    // Set focus
    const filtered = getFiltered();
    state.activeIdx = filtered.findIndex(j => j.id === id);
    render();
  });

  // Keyboard navigation
  document.addEventListener('keydown', e => {
    const isInput = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT';

    if (e.key === '/' && !isInput) {
      e.preventDefault(); searchInput.focus(); searchInput.select();
      return;
    }
    if (e.key === 'Escape') {
      if (state.search) {
        searchInput.value = ''; searchClear.classList.remove('show');
        state.search = ''; render();
      }
      if (state.expandedId) { state.expandedId = null; render(); }
      searchInput.blur();
      return;
    }

    if (isInput) return;

    const filtered = getFiltered();
    if (!filtered.length) return;

    if (e.key === 'j' || e.key === 'ArrowDown') {
      e.preventDefault();
      state.activeIdx = Math.min(state.activeIdx + 1, filtered.length - 1);
      state.expandedId = null;
      render();
      scrollToActive();
    }
    if (e.key === 'k' || e.key === 'ArrowUp') {
      e.preventDefault();
      state.activeIdx = Math.max(state.activeIdx - 1, 0);
      state.expandedId = null;
      render();
      scrollToActive();
    }
    if (e.key === 'Enter' && state.activeIdx >= 0) {
      const job = filtered[state.activeIdx];
      state.expandedId = state.expandedId === job.id ? null : job.id;
      render();
    }
    if (e.key === 'o' && state.activeIdx >= 0) {
      e.preventDefault();
      const job = filtered[state.activeIdx];
      window.open(job.url, '_blank');
    }
  });
}

function scrollToActive() {
  const el = document.querySelector('.job-card.focused');
  if (el) el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
}

// ── Filter + Sort ────────────────────────────────────
function getFiltered() {
  let arr = [...jobs];

  if (state.search) {
    const terms = state.search.toLowerCase().split(/\s+/).filter(Boolean);
    arr = arr.filter(j => {
      const txt = [j.title, j.company, j.location, j.department, j.description || ''].join('\x00').toLowerCase();
      return terms.every(t => txt.includes(t));
    });
  }
  if (state.location === 'bay') arr = arr.filter(j => j.is_bay_area);
  else if (state.location === 'other') arr = arr.filter(j => !j.is_bay_area);
  if (state.company !== 'all') arr = arr.filter(j => j.company === state.company);

  const [col, dir] = state.sort.split('-');
  arr.sort((a, b) => {
    let va = a[col] || a.discovered_at || '';
    let vb = b[col] || b.discovered_at || '';
    if (typeof va === 'string') va = va.toLowerCase();
    if (typeof vb === 'string') vb = vb.toLowerCase();
    return (va < vb ? -1 : va > vb ? 1 : 0) * (dir === 'asc' ? 1 : -1);
  });

  return arr;
}

// ── Render ───────────────────────────────────────────
function render() {
  const filtered = getFiltered();

  // Header count
  const newCount = jobs.filter(j => !j.notified).length;
  document.getElementById('headerCount').innerHTML =
    `<b>${filtered.length}</b> of ${jobs.length} jobs` +
    (newCount > 0 ? ` &middot; <b>${newCount}</b> new` : '');

  // Job list
  const list = document.getElementById('jobList');

  if (!filtered.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">&#128269;</div>
      <h3>No jobs match</h3><p>Try broadening your search or filters</p></div>`;
    return;
  }

  let html = '';
  filtered.forEach((j, i) => {
    const isActive = state.expandedId === j.id;
    const isFocused = state.activeIdx === i;
    const isNew = !j.notified;
    const isBay = j.is_bay_area;
    const src = (j.source || '').split(':')[0].toLowerCase();
    const descSnippet = stripHtml(j.description || '').substring(0, 160);

    let cls = 'job-card';
    if (isActive) cls += ' active';
    if (isFocused) cls += ' focused';
    if (isBay) cls += ' bay-area';

    html += `<div class="${cls}" data-id="${j.id}">
      <div class="card-top">
        <div class="card-body">
          <div class="card-title">
            ${highlight(j.title, state.search)}
            ${isNew ? '<span class="tag tag-new">New</span>' : ''}
            ${isBay ? '<span class="tag tag-bay">Bay Area</span>' : ''}
          </div>
          <div class="card-meta">
            <span class="card-meta-item">
              <span class="source-dot source-${src}"></span>
              ${highlight(j.company, state.search)}
            </span>
            ${j.location ? `<span class="card-meta-item">${highlight(j.location, state.search)}</span>` : ''}
            ${j.date_posted ? `<span class="card-meta-item">${relDate(j.date_posted)}</span>` : ''}
          </div>
          ${descSnippet ? `<div class="card-desc">${highlight(descSnippet, state.search)}</div>` : ''}
        </div>
        <div class="card-actions">
          <a href="${esc(j.url)}" target="_blank" rel="noopener" class="btn-open" onclick="event.stopPropagation()">
            Open <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          </a>
        </div>
      </div>
    </div>`;

    if (isActive) {
      const found = fmtDateTime(j.date_found || j.discovered_at);
      const posted = fmtDate(j.date_posted);
      html += `<div class="card-detail">
        <div class="detail-grid">
          <div class="detail-cell"><div class="detail-label">Found</div><div class="detail-val">${found || 'Unknown'}</div></div>
          <div class="detail-cell"><div class="detail-label">Posted</div><div class="detail-val">${posted || 'Unknown'}</div></div>
          <div class="detail-cell"><div class="detail-label">Department</div><div class="detail-val">${esc(j.department) || 'Not specified'}</div></div>
          <div class="detail-cell"><div class="detail-label">Source</div><div class="detail-val"><span class="source-dot source-${src}" style="display:inline-block;vertical-align:middle;margin-right:4px"></span>${esc(j.source)}</div></div>
        </div>
        <div class="detail-url">
          <a href="${esc(j.url)}" target="_blank">${esc(j.url)}</a>
          <button class="btn-copy" data-url="${esc(j.url)}">Copy</button>
        </div>
        ${j.description ? `<div class="detail-desc">${esc(j.description)}</div>` : ''}
      </div>`;
    }
  });

  list.innerHTML = html;
}

// ── Helpers ──────────────────────────────────────────
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function stripHtml(s) { return s ? s.replace(/<[^>]*>/g, '') : ''; }
function highlight(text, search) {
  if (!search || !text) return esc(text || '');
  const terms = search.toLowerCase().split(/\s+/).filter(Boolean);
  let result = esc(text);
  for (const t of terms) {
    result = result.replace(new RegExp('(' + t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')', 'gi'), '<mark>$1</mark>');
  }
  return result;
}
function relDate(d) {
  if (!d) return '';
  try {
    const dt = new Date(d);
    if (isNaN(dt)) return esc(d);
    const diff = Math.floor((Date.now() - dt) / 86400000);
    if (diff < 0) return fmtDate(d);
    if (diff === 0) return 'Today';
    if (diff === 1) return 'Yesterday';
    if (diff < 7) return diff + 'd ago';
    if (diff < 30) return Math.floor(diff/7) + 'w ago';
    return fmtDate(d);
  } catch { return esc(d); }
}
function fmtDate(d) {
  if (!d) return '';
  try { const dt = new Date(d); return isNaN(dt) ? d : dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); } catch { return d; }
}
function fmtDateTime(d) {
  if (!d) return '';
  try { const dt = new Date(d); return isNaN(dt) ? d : dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'}); } catch { return d; }
}

// ── Go ───────────────────────────────────────────────
init();
</script>
</body>
</html>
